<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>Document</title>
</head>
<script src="../easyui/jquery.min.js"></script>
<script src="../easyui/jquery.easyui.min.1.js"></script>
<script src="../easyui/plugins/jquery.datagrid.js"></script>
<script src="../easyui/locale/easyui-lang-zh_CN.js"></script>
<link rel="stylesheet" href="../easyui/themes/default/easyui.css" />
<link rel="stylesheet" href="../easyui/themes/icon.css" />
<script src="../address.js"></script>
<style>
    * {
        margin: 0px;
        padding: 0px;
    }

    .sxd {
        margin-left: 472px;
        margin-top: -215px;
        position: absolute;
    }
</style>

<body>

    <table id="dg" width="470" toolbar="#tb" title="网关信息">
    </table>
    <div class="sxd">
        <table id="w" width="683" toolbar="#tb2" title="节点信息">
        </table>
    </div>

    <div id="tb">
        <div>
            <a href="javascript:openRoleAddDialog()" class="easyui-linkbutton" iconCls="icon-add" plain="true">添加</a>
            <a href="javascript:openRoleModifyDialog()" class="easyui-linkbutton" iconCls="icon-edit" plain="true">修改</a>
            <a href="javascript:deleteRole()" class="easyui-linkbutton" iconCls="icon-remove" plain="true">删除</a>
        </div>
        <div>
            &nbsp;网关号：&nbsp;
            <input type="text" name="mark" id="idd" size="20" onkeydown="if(event.keyCode==13) searchRole()" />
            <a href="javascript:searchRole()" class="easyui-linkbutton" iconCls="icon-search" plain="true">搜索</a>
        </div>
    </div>
    <div id="tb2" style="display:none;">
        <div>
            <a href="javascript:openRoleAddDialog1()" class="easyui-linkbutton" iconCls="icon-add" plain="true">添加</a>
            <a href="javascript:openRoleModifyDialog1()" class="easyui-linkbutton" iconCls="icon-edit" plain="true">修改</a>
            <a href="javascript:deleteRole1()" class="easyui-linkbutton" iconCls="icon-remove" plain="true">删除</a>
        </div>
        <div>
            &nbsp;节点号：&nbsp;
            <input type="text" name="mark" id="idd" size="20" onkeydown="if(event.keyCode==13) searchRole()" />
            <a href="javascript:searchRole()" class="easyui-linkbutton" iconCls="icon-search" plain="true">搜索</a>
        </div>
    </div>

    <div id="dlg" class="easyui-dialog" style="width: 570px;height: 350px;padding: 10px 20px" closed="true" buttons="#dlg-buttons2">
        <form id="fm" method="post">
            <table cellspacing="5px;">
                <tr>
                    <td>网关盒子对应ID：</td>
                    <td width="80%">
                        <input type="text" id="roleName" name="getwayMark" class="easyui-validatebox" required="true" />
                    </td>
                </tr>
                <tr>
                    <td>网关状态：</td>
                    <td width="80%">
                        <input type="text" id="roleName" name="status" class="easyui-validatebox" required="true" list="itemlist" />
                        <datalist id="itemlist">
                            <option value="0">不在线</option>
                            <option value="1">在线</option>
                        </datalist>
                    </td>
                </tr>
                <tr>
                    <td>是否备用：</td>
                    <td width="80%">
                        <input type="text" id="roleName" name="spareNode" class="easyui-validatebox" required="true" list="itemlist2" />
                        <datalist id="itemlist2">
                            <option value="0">否</option>
                            <option value="1">是</option>
                        </datalist>
                    </td>
                </tr>
                <tr>
                    <td>网关编号：</td>
                    <td width="80%">
                        <input type="text" id="roleName" name="nodeNum" class="easyui-validatebox" required="true" />
                    </td>
                </tr>
                <tr>
                    <td>备注：</td>
                    <td width="80%">
                        <input type="text" id="roleName" name="memo" class="easyui-validatebox" required="true" />
                    </td>
                </tr>
            </table>
        </form>
    </div>
    <div id="dlg1" class="easyui-dialog" style="width: 570px;height: 350px;padding: 10px 20px" closed="true" buttons="#dlg-buttons">
        <form id="fm2" method="post">
            <table cellspacing="5px;">
                <tr>
                    <td>节点盒子ID：</td>
                    <td width="80%">
                        <input type="text" id="roleName" name="nodeMark" class="easyui-validatebox" required="true" />
                    </td>
                </tr>
                <tr>
                    <td>节点状态：</td>
                    <td width="80%">
                        <input type="text" id="roleName" name="status" class="easyui-validatebox" required="true" list="itemlist" />
                        <datalist id="itemlist">
                            <option value="0">不在线</option>
                            <option value="1">在线</option>
                        </datalist>
                    </td>
                </tr>
                <tr>
                    <td>类型(节点)：</td>
                    <td width="80%">
                        <input type="text" id="roleName" name="type" class="easyui-validatebox" required="true" list="itemlist2" />
                        <datalist id="itemlist2">
                            <option value="0">否</option>
                            <option value="1">是</option>
                        </datalist>
                    </td>
                </tr>

            </table>
        </form>
    </div>
    <div id="dlg-buttons">
        <a href="javascript:saveRole1()" class="easyui-linkbutton" iconCls="icon-ok">保存</a>
        <a href="javascript:closeRoleSaveDialog()" class="easyui-linkbutton" iconCls="icon-cancel">关闭</a>
    </div>

    <div id="dlg2" class="easyui-dialog" style="width: 300px;height: 450px;padding: 10px 20px" closed="true" buttons="#dlg2-buttons">
        <ul id="tree" class="easyui-tree"></ul>
    </div>

    <div id="dlg-buttons2">
        <a href="javascript:saveRole()" class="easyui-linkbutton" iconCls="icon-ok">保存</a>
        <a href="javascript:closeRoleSaveDialog()" class="easyui-linkbutton" iconCls="icon-cancel">关闭</a>
    </div>

    <div id="dlg2" class="easyui-dialog" style="width: 300px;height: 450px;padding: 10px 20px" closed="true" buttons="#dlg2-buttons">
        <ul id="tree" class="easyui-tree"></ul>
    </div>
</body>
<script>
    var id;

    $(function () {

        $("#dg").datagrid({
            singleSelect: true,
            dataType: 'json',
            url: address + "/data/getways/simple",
            columns: [
                [{
                        title: '编号',
                        field: 'getwayId',
                        width: 100,
                        checkbox: true, //这个checkbox:true 就表示让Id这一行显示为复选框的样式。  
                    },
                    {
                        field: 'getwayMark',
                        title: '网关号',
                        width: 110
                    },
                    {
                        field: 'status',
                        title: '网关状态',
                        width: 110
                    },
                    {
                        field: 'snr',
                        title: '网关编号',
                        width: 110
                    },
                    {
                        field: 'statusDesc',
                        title: '状态描述',
                        width: 110
                    }
                ]
            ],
            pagination: true,
            pageSize: 10,
            pageList: [1, 2, 10],
            onClickRow: function (index, row) {
                id = row["getwayMark"];
                getwayid = row["getwayId"];

                $.ajax({
                    url: address + "/data/getway/" + id + "/subNodes",
                    type: 'post',
                    success: function () {

                        $('#w').window('open');
                    }
                });
                $("#w").datagrid({
                    singleSelect: true,
                    dataType: 'json',
                    url: address + "/data/getway/" + id + "/subNodes",
                    columns: [
                        [{
                                title: '编号',
                                field: 'Id',
                                width: 100,
                                checkbox: true, //这个checkbox:true 就表示让Id这一行显示为复选框的样式。  
                            },
                            {
                                field: 'nodeId',
                                title: '节点号',
                                width: 110
                            },
                            {
                                field: 'status',
                                title: '网关状态',
                                width: 110,
                                formatter: function (value, row, index) {

                                    if (value == 1) {
                                        return "在线"
                                    } else {
                                        return "不在线"
                                    }
                                }
                            },
                            {
                                field: 'nodeMark',
                                title: '节点盒子ID',
                                width: 110
                            },
                            {
                                field: 'nowTemper',
                                title: '当前温度',
                                width: 110
                            },
                            {
                                field: 'nowHumidity',
                                title: '当前湿度',
                                width: 110
                            },
                            {
                                field: 'type',
                                title: '类型(节点)',
                                width: 100
                            }

                        ]
                    ],
                    pagination: true,
                    pageSize: 8,
                    pageList: [1, 2, 8],
                });

            }

        });
    });

    function searchRole() {
        $("#chaxun").datagrid({
            dataType: 'json',
            url: address + "/search/getway/" + $("#idd").val(),
            columns: [
                [{
                        title: '编号',
                        field: 'Id',
                        width: 100,
                        checkbox: true, //这个checkbox:true 就表示让Id这一行显示为复选框的样式。  
                    },
                    {
                        field: 'getwayMark',
                        title: '网关号',
                        width: 248
                    },
                    {
                        field: 'status',
                        title: '网关状态',
                        width: 248
                    }
                ]
            ],

        });
    }
    var url = "";

    function openRoleAddDialog() {
        $("#dlg").dialog("open").dialog("setTitle", "添加网关信息");
        url = address + "/manage/getway"; //添加网关信息的时候的url
    }

    function openRoleAddDialog1() {
        $("#dlg1").dialog("open").dialog("setTitle", "添加节点信息");
        url = address + "/manage/node"; //添加网关信息的时候的url
    }

    function saveRole() {


        $.ajax({
            url: url,
            type: "post",
            data: $("#fm").serialize(),
            xhrFields: {
                withCredentials: true
            },
            crossDomain: true,
            success: function (result) {
                if (result.success == true) {
                    alert("提交成功!");
                    closeRoleSaveDialog();
                } else {
                    alert("次网关已存在，请重新添加");
                }
            },

        });
    }

    function saveRole1() {


        $("#fm2").form("submit", {
            url: url,
            xhrFields: {
                withCredentials: true
            },
            crossDomain: true,

            onSubmit: function (param) {
                param.getwayId = getwayid;
                console.log(param);
            },
            success: function (result) {
                alert("保存成功");
            },
        });
    }

    function closeRoleSaveDialog() {
        $("#dlg").dialog("close");
        $("#fm").form('clear');
    }

    function deleteRole() {
        var selectedRows = $("#dg").datagrid('getSelections');

        if (selectedRows.length == 0) {
            $.messager.alert('系统提示', '请选择要删除的数据！');
            return;
        }
        var strIds = [];
        for (var i = 0; i < selectedRows.length; i++) {
            strIds.push(selectedRows[i].getwayMark);
        }
        alert(strIds);
        var ids = strIds.join(",");
        $.messager.confirm("系统提示", "您确认要删除这<font color=red>" + selectedRows.length + "</font>条数据吗？", function (r) {
            if (r) {
                $.ajax({
                    url: address + "/manage/getway/" + strIds,
                    type: 'delete',
                    xhrFields: {
                        withCredentials: true
                    },
                    crossDomain: true,
                    success: function (result) {
                        if (result.success) {
                            $.messager.alert('系统提示', "您已成功删除数据！");
                            $("#dg").datagrid("reload");
                        } else {
                            alert('系统提示删除失败');
                        }
                    }
                });
            }
        });
    }

    function deleteRole1() {
        var selectedRows = $("#w").datagrid('getSelections');

        if (selectedRows.length == 0) {
            $.messager.alert('系统提示', '请选择要删除的数据！');
            return;
        }
        var strIds = [];
        for (var i = 0; i < selectedRows.length; i++) {
            strIds.push(selectedRows[i].nodeMark);
        }
        alert(strIds);
        var ids = strIds.join(",");
        $.messager.confirm("系统提示", "您确认要删除这<font color=red>" + selectedRows.length + "</font>条数据吗？", function (r) {
            if (r) {

                $.ajax({
                    url: address + "/manage/node/" + strIds,
                    type: 'delete',
                    xhrFields: {
                        withCredentials: true
                    },
                    crossDomain: true,
                    success: function (result) {
                        if (result.success) {
                            $.messager.alert('系统提示', "您已成功删除数据！");
                            $("#dg").datagrid("reload");
                        } else {
                            alert('系统提示删除失败');
                        }
                    }
                });
            }
        });
    }

    function openRoleModifyDialog() {
        var selectedRows = $("#dg").datagrid('getSelections');

        if (selectedRows.length != 1) {
            $.messager.alert('系统提示', '请选择一条要编辑的数据！');
            return;
        }
        var row = selectedRows[0];
        $("#dlg").dialog("open").dialog("setTitle", "修改信息");
        $("#fm").form("load", row);
        url = address + "/manage/getway/update"; //修改的时候的url
    }


    function openRoleModifyDialog1() {

        var selectedRows = $("#w").datagrid('getSelections');

        if (selectedRows.length != 1) {
            $.messager.alert('系统提示', '请选择一条要编辑的数据！');
            return;
        }
        var row = selectedRows[0];
        $("#dlg1").dialog("open").dialog("setTitle", "修改信息");
        $("#fm2").form("load", row);
        url = address + "/manage/node/update"; //修改的时候的url
    }
</script>

</html>